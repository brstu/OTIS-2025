/**
 * @file test_pid_basic.cpp
 * @brief Два теста для проверки работы PID-регулятора (Google Test 4.2.0)
 *
 * Этот файл содержит два основных теста:
 * 1. ProportionalControlTest - проверяет работу пропорциональной составляющей
 * 2. OutputLimitsTest - проверяет ограничение выходного сигнала регулятора
 */

#include <gtest/gtest.h>
#include "../src/pid_controller.h"
#include <cmath>

 /**
  * @test ProportionalControlTest
  * @brief Тест проверяет правильность работы пропорциональной составляющей
  *
  * Пропорциональная составляющая вычисляется как Kp * error.
  * Тест проверяет, что при разных значениях ошибки и коэффициенте Kp
  * регулятор правильно вычисляет управляющее воздействие.
  */
TEST(PIDControllerTest, ProportionalControlTest) {
    // Создаем регулятор только с пропорциональной составляющей
    PIDController pid(2.5, 0.0, 0.0);  // Kp=2.5, Ki=0, Kd=0

    // Устанавливаем заданное значение температуры
    pid.setSetpoint(75.0);

    // Тест 1: Положительная ошибка
    // Температура 65°C, ошибка = 10°C, Kp=2.5 => 2.5 * 10 = 25
    double control = pid.calculate(65.0, 0.1);
    EXPECT_NEAR(control, 25.0, 0.001);

    // Сбрасываем регулятор для следующего теста
    pid.reset();

    // Тест 2: Нулевая ошибка
    pid.setSetpoint(80.0);
    pid.reset();
    control = pid.calculate(80.0, 0.1);  // Ошибка = 0°C
    EXPECT_NEAR(control, 0.0, 0.001);    // 2.5 * 0 = 0
}

/**
 * @test OutputLimitsTest
 * @brief Тест проверяет ограничение выходного сигнала регулятора
 *
 * PID-регулятор должен ограничивать выходной сигнал в заданных пределах.
 * Это предотвращает чрезмерное управляющее воздействие и защищает оборудование.
 */
TEST(PIDControllerTest, OutputLimitsTest) {
    // Создаем регулятор с ограничениями выходного сигнала от 0 до 100
    PIDController pid(10.0, 0.5, 1.0, 0.0, 100.0);

    // Устанавливаем высокую заданную температуру
    pid.setSetpoint(200.0);

    // Тест 1: Проверяем верхнее ограничение
    // При температуре 50°C, ошибка = 150°C
    // P = 10.0 * 150 = 1500 (но должно быть ограничено 100)
    double control = pid.calculate(50.0, 0.1);
    EXPECT_LE(control, 100.0);  // Не должно превышать 100
    EXPECT_GT(control, 0.0);    // И должно быть положительным

    // Сбрасываем регулятор
    pid.reset();

    // Тест 2: Проверяем нижнее ограничение
    pid.setSetpoint(0.0);  // Низкая заданная температура
    control = pid.calculate(100.0, 0.1);  // Ошибка = -100°C
    // P = 10.0 * (-100) = -1000 (но должно быть ограничено 0)
    EXPECT_GE(control, 0.0);    // Не должно быть меньше 0
    EXPECT_LE(control, 100.0);  // И не должно превышать 100

    // Тест 3: Проверяем работу в пределах диапазона
    pid.setSetpoint(80.0);
    pid.reset();
    control = pid.calculate(70.0, 0.1);  // Ошибка = 10°C
    // Результат должен быть в пределах 0-100
    EXPECT_GE(control, 0.0);
    EXPECT_LE(control, 100.0);
}

/**
 * @brief Основная функция запуска тестов
 *
 * Инициализирует Google Test и запускает все тесты.
 *
 * @param argc Количество аргументов командной строки
 * @param argv Аргументы командной строки
 * @return Код завершения тестов
 */
int main(int argc, char** argv) {
    // Инициализируем Google Test
    ::testing::InitGoogleTest(&argc, argv);

    // Запускаем все тесты
    return RUN_ALL_TESTS();
}