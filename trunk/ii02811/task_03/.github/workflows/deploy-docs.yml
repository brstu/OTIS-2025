# Название workflow (видно в интерфейсе GitHub)
name: Deploy Doxygen Documentation to GitHub Pages

# КОГДА запускать:
# - При push в ветки main или master
# - При ручном запуске (workflow_dispatch)
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# ПРАВА доступа (нужны для публикации)
permissions:
  contents: read      # Чтение кода
  pages: write        # Запись на GitHub Pages
  id-token: write     # Для аутентификации

# Задачи выполняются последовательно
jobs:
  # ЗАДАЧА 1: Сборка документации
  build-docs:
    runs-on: ubuntu-latest    # Запуск на виртуальной машине Ubuntu
    
    steps:
    # Шаг 1: Получить код из репозитория
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # Шаг 2: Настроить GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    # Шаг 3: Установить Doxygen
    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen
    
    # Шаг 4: Создать целевую папку для документации
    - name: Create target directory
      run: |
        mkdir -p trunk/ii02811/task_03/doc/html
        echo "Target directory created: trunk/ii02811/task_03/doc/html"
    
    # Шаг 5: Сгенерировать документацию
    - name: Generate documentation with Doxygen
      run: |
        echo "Generating Doxygen documentation..."
        doxygen Doxyfile.txt
        
        echo "Generated files:"
        ls -la trunk/ii02811/task_03/doc/html/ | head -10
    
    # Шаг 6: Загрузить артефакт (документацию) для публикации
    - name: Upload documentation artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./trunk/ii02811/task_03/doc/html

  # ЗАДАЧА 2: Публикация на GitHub Pages
  deploy:
    # Запуск только после успешной сборки
    needs: build-docs
    
    # Специальное окружение для GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
    # Развернуть документацию на GitHub Pages
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4