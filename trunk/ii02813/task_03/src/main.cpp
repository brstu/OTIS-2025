#include <iostream>
#include "models.h"
#include "pid.h"

/**
 * @brief Точка входа в программу моделирования PID-регулятора.
 *
 * Программа моделирует работу дискретного PID-регулятора для управления
 * линейной моделью объекта. Пользователь вводит коэффициенты модели,
 * начальное и целевое значение температуры, а также количество шагов моделирования.
 *
 * Алгоритм работы:
 * - Запрос коэффициентов линейной модели a и b.
 * - Запрос начальной температуры и целевой температуры.
 * - Запрос числа шагов моделирования.
 * - На каждом шаге вычисляется отклонение между целевой и текущей температурой.
 * - PID-регулятор формирует управляющее воздействие.
 * - Линейная модель рассчитывает новое значение температуры.
 * - Нелинейная модель рассчитывает новое значение температуры.
 * - Результаты выводятся в консоль.
 *
 * @return код завершения программы.
 */
int main()
{
    const double K01  = 0.06;  ///< коэффициент передачи
    const double T01  = 20.0; ///< постоянная интегрирования
    const double Td01 = 0.0;  ///< постоянная дифференцирования
    const double T001 = 1.0;  ///< шаг
    
    pid_coeffs coeffs(K01, T01, Td01, T001);
    pid PID(coeffs, 1, 2, 3);

    const double a01_lin = 0.8; ///< коэффициент линейной модели a
    const double b01_lin = 0.1; ///< коэффициент линейной модели b

    NonLinearCoeffs coeffs_nl;
    coeffs_nl.a01 = 0.8;  ///< коэффициент нелинейной модели a
    coeffs_nl.b01 = 0.0;  ///< коэффициент нелинейной модели b
    coeffs_nl.c01 = 0.1;  ///< коэффициент нелинейной модели c
    coeffs_nl.d01 = 0.05; ///< коэффициент нелинейной модели d

    double y01; ///< текущее значение температуры
    double w01; ///< целевая температура
    int n01;    ///< количество шагов моделирования

    std::cout << "Enter initial temperature -> ";
    std::cin >> y01;
    std::cout << "Enter target temperature -> ";
    std::cin >> w01;
    std::cout << "Enter number of steps -> ";
    std::cin >> n01;

    double e01; ///< значение отклонения 
    double u01; ///< значение управляющего воздействия

    double y01_nl = y01;
    double y01_prev = 0;
    double u01_prev = 0;

    for (int i01 = 0; i01 < n01; i01++)
    {
        e01 = w01 - y01;              ///< вычисление значение отклонения 
        u01 = PID.process(e01);     ///< нахождение значения управляющего воздействия

        y01 = linear(y01, u01, a01_lin, b01_lin); ///< расчёт новой температуры по линейной модели

        y01_nl = non_linear(y01_nl, y01_prev, u01, u01_prev, coeffs_nl); ///< расчёт новой температуры по нелинейной модели
        y01_prev = y01_nl;
        u01_prev = u01;

        std::cout << "Step " << i01 + 1 
                  << " - e = " << e01 
                  << ", u = " << u01
                  << ", y_lin = " << y01 
                  << ", y_nonlin = " << y01_nl 
                  << ";\n";
    }

    return 0;
}